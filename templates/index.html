{% extends "base.html" %}

{% block content %}
<div class="main-container">
    <!-- File Explorer Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-folder-tree"></i> File Explorer
        </div>
        
        <div class="sidebar-controls">
            <button class="btn btn-sm btn-outline-primary w-100 mb-2" onclick="refreshFileTree()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
            <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="expandAll()">
                <i class="fas fa-expand-arrows-alt"></i> Expand All
            </button>
            <button class="btn btn-sm btn-outline-secondary w-100 mb-2" onclick="collapseAll()">
                <i class="fas fa-compress-arrows-alt"></i> Collapse All
            </button>
            <button class="btn btn-sm btn-outline-warning w-100" onclick="clearFilters()">
                <i class="fas fa-eraser"></i> Clear Filters
            </button>
            
            <div class="filter-status" id="filterStatus">
                <div>Included: <span id="includedCount">0</span> folders</div>
                <div>Excluded: <span id="excludedCount">0</span> folders</div>
            </div>
        </div>
        
        <div class="file-tree" id="fileTree">
            <div class="text-center p-3">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div>Loading file tree...</div>
            </div>
        </div>
    </div>
    
    <!-- File Viewer Modal -->
    <div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="fileViewerModalLabel">
                        <i class="fas fa-file-alt me-2"></i>
                        <span id="fileViewerTitle">Loading...</span>
                    </h5>
                    <div class="modal-header-actions">
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="toggleViewMode">
                            <i class="fas fa-code"></i> Raw
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="copyFileContent()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div id="fileViewerContent" class="file-viewer-content">
                        <div class="text-center p-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2">Loading file content...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="file-info text-muted small me-auto" id="fileInfo">
                        <!-- File info will be populated here -->
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-area">
        <div class="search-container">
            <!-- Search Input -->
            <div class="search-box">
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control" id="searchTerms" 
                           placeholder="Enter search terms... (use quotes for exact phrases)">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                
                <div class="search-options">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchMode" id="modeAll" value="ALL" checked>
                                <label class="form-check-label" for="modeAll">ALL terms (AND)</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="searchMode" id="modeAny" value="ANY">
                                <label class="form-check-label" for="modeAny">ANY terms (OR)</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="caseSensitive">
                                <label class="form-check-label" for="caseSensitive">Case sensitive</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters Panel -->
            <div class="filters-panel">
                <div class="row">
                    <div class="col-md-4">
                        <label for="excludeTerms" class="form-label">Exclude terms:</label>
                        <input type="text" class="form-control" id="excludeTerms" 
                               placeholder="Terms to exclude from results">
                    </div>
                    <div class="col-md-4">
                        <label for="searchIn" class="form-label">Search in:</label>
                        <select class="form-select" id="searchIn">
                            <option value="all">All content</option>
                            <option value="title">Titles only</option>
                            <option value="content">Content only</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Date range:</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" id="dateFrom" placeholder="From">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" id="dateTo" placeholder="To">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Stats -->
            <div id="searchStats" class="search-stats" style="display: none;">
                <span id="resultsCount">0</span> files found
                <span id="searchTime" style="margin-left: 1rem;"></span>
            </div>
            
            <!-- Export Buttons -->
            <div class="export-buttons" id="exportButtons" style="display: none;">
                <button class="btn btn-success me-2" onclick="exportResults('csv')">
                    <i class="fas fa-file-csv"></i> Export Full CSV
                </button>
                <button class="btn btn-outline-success me-2" onclick="exportResults('csv-paths')">
                    <i class="fas fa-list"></i> Export Paths Only
                </button>
                <button class="btn btn-info" onclick="exportResults('json')">
                    <i class="fas fa-file-code"></i> Export JSON
                </button>
            </div>

            <!-- JEF Results Sorting Controls -->
            <div class="jef-sorting-controls" id="jefSortingControls" style="display: none;">
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-sort"></i> Sort & Filter Results by JEF Scores</h6>
                    </div>
                    <div class="card-body">
                        <div class="jef-filter-controls">
                            <label for="jefSortBy" class="form-label mb-0">Sort by:</label>
                            <select id="jefSortBy" class="form-select" onchange="sortSearchResultsByJef()">
                                <option value="original">Original Order</option>
                                <option value="score-desc">JEF Score (High to Low)</option>
                                <option value="score-asc">JEF Score (Low to High)</option>
                                <option value="percentage-desc">JEF Percentage (High to Low)</option>
                                <option value="percentage-asc">JEF Percentage (Low to High)</option>
                                <option value="title">Title (A-Z)</option>
                                <option value="matches">Search Matches (High to Low)</option>
                            </select>
                            
                            <label for="jefFilterScore" class="form-label mb-0">Min Score:</label>
                            <input type="number" id="jefFilterScore" class="form-control" 
                                   placeholder="0.0" step="0.01" min="0" max="1" 
                                   onchange="filterSearchResultsByJef()">
                            
                            <label for="jefFilterPercentage" class="form-label mb-0">Min %:</label>
                            <input type="number" id="jefFilterPercentage" class="form-control" 
                                   placeholder="0" step="1" min="0" max="100" 
                                   onchange="filterSearchResultsByJef()">
                            
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearJefFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                        
                        <div class="jef-score-legend mt-2">
                            <div class="jef-score-legend-item">
                                <div class="jef-score-legend-color" style="background: linear-gradient(135deg, #ffd700, #ffed4e);"></div>
                                <span>Perfect (100%)</span>
                            </div>
                            <div class="jef-score-legend-item">
                                <div class="jef-score-legend-color" style="background: #22c55e;"></div>
                                <span>Excellent (70-99%)</span>
                            </div>
                            <div class="jef-score-legend-item">
                                <div class="jef-score-legend-color" style="background: #fbbf24;"></div>
                                <span>Good (50-69%)</span>
                            </div>
                            <div class="jef-score-legend-item">
                                <div class="jef-score-legend-color" style="background: #f97316;"></div>
                                <span>Moderate (30-49%)</span>
                            </div>
                            <div class="jef-score-legend-item">
                                <div class="jef-score-legend-color" style="background: #ef4444;"></div>
                                <span>Poor (&lt;30%)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- JEF Analysis Section -->
            <div class="jef-section" id="jefSection" style="display: none;">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-shield-alt"></i> JEF Analysis</h5>
                    </div>
                    <div class="card-body">
                        <div class="jef-status" id="jefStatus">
                            <span class="text-muted">Checking JEF availability...</span>
                        </div>
                        <div class="jef-controls" id="jefControls" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="jefTestType" class="form-label">Analysis Type:</label>
                                    <select id="jefTestType" class="form-select" onchange="toggleReferenceText()">
                                        <option value="">Select test type...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Selected File:</label>
                                    <div id="jefSelectedFile" class="form-control-plaintext text-muted">
                                        Click on a search result to select it
                                    </div>
                                </div>
                            </div>
                            <div class="jef-reference mt-3" id="jefReference" style="display: none;">
                                <label for="jefReferenceText" class="form-label">Reference Text:</label>
                                <textarea id="jefReferenceText" class="form-control" rows="3" 
                                         placeholder="Enter reference text for copyright analysis..."></textarea>
                            </div>
                            <div class="jef-buttons mt-3">
                                <button onclick="runJefAnalysis('single')" class="btn btn-warning me-2" id="jefSingleBtn" disabled>
                                    <i class="fas fa-search"></i> Analyze Selected File
                                </button>
                                <button onclick="runJefAnalysis('batch')" class="btn btn-danger" id="jefBatchBtn" disabled>
                                    <i class="fas fa-layer-group"></i> Analyze All Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            
            <!-- Results Container -->
            <div class="results-container">
                <div id="loadingIndicator" class="loading" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Searching...</span>
                    </div>
                    <p class="mt-2">Searching your ChatGPT archive...</p>
                </div>
                
                <div id="noResults" class="no-results" style="display: none;">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>No results found</h5>
                    <p>Try different search terms or adjust your filters</p>
                </div>
                
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="contextAction('include')">
        <i class="fas fa-check-circle text-success"></i> Include this folder
    </div>
    <div class="context-menu-item" onclick="contextAction('exclude')">
        <i class="fas fa-times-circle text-danger"></i> Exclude this folder
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="contextAction('includeSubfolders')">
        <i class="fas fa-check-double text-success"></i> Include folder + subfolders
    </div>
    <div class="context-menu-item" onclick="contextAction('excludeSubfolders')">
        <i class="fas fa-ban text-danger"></i> Exclude folder + subfolders
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="contextAction('expandFrom')">
        <i class="fas fa-sitemap"></i> Expand tree from here
    </div>
    <div class="context-menu-item" onclick="contextAction('collapseFrom')">
        <i class="fas fa-minus-square"></i> Collapse from here
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="contextAction('addToIgnore')">
        <i class="fas fa-eye-slash"></i> Add to ignore list
    </div>
    <div class="context-menu-item" onclick="contextAction('removeFromIgnore')">
        <i class="fas fa-eye"></i> Remove from ignore list
    </div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="contextAction('showInResults')">
        <i class="fas fa-search"></i> Show files in results
    </div>
    <div class="context-menu-item" onclick="contextAction('copyPath')">
        <i class="fas fa-copy"></i> Copy path
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentResults = [];
let searchStartTime = 0;
let fileTree = {};
let expandedFolders = new Set();
let includedFolders = new Set();
let excludedFolders = new Set();
let ignoredItems = new Set();
let currentContextPath = '';
let currentContextItem = null;
let jefAvailable = false;
let jefTests = [];
let selectedFile = null;
let currentJefTestType = '';
let originalResultsOrder = [];
let jefResultsData = {}; // Store JEF results by file path

// Debounce function to limit search frequency
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Perform search
function performSearch() {
    const searchTerms = $('#searchTerms').val().trim();
    
    if (!searchTerms) {
        $('#searchResults').empty();
        $('#searchStats').hide();
        $('#exportButtons').hide();
        return;
    }
    
    const searchData = {
        terms: searchTerms,
        exclude: $('#excludeTerms').val().trim(),
        mode: $('input[name="searchMode"]:checked').val(),
        searchIn: $('#searchIn').val(),
        caseSensitive: $('#caseSensitive').is(':checked'),
        dateFrom: $('#dateFrom').val(),
        dateTo: $('#dateTo').val(),
        includedFolders: Array.from(includedFolders),
        excludedFolders: Array.from(excludedFolders)
    };
    
    // Show loading indicator
    $('#loadingIndicator').show();
    $('#searchResults').empty();
    $('#noResults').hide();
    $('#searchStats').hide();
    $('#exportButtons').hide();
    
    // Hide JEF scores from previous searches (true = clear all data)
    hideAllJefScores(true);
    
    searchStartTime = Date.now();
    
    // Perform AJAX search
    $.ajax({
        url: '/search',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(searchData),
        success: function(response) {
            $('#loadingIndicator').hide();
            
            if (response.success) {
                currentResults = response.results;
                originalResultsOrder = [...response.results]; // Store original order
                jefResultsData = {}; // Clear previous JEF data
                displayResults(response.results);
                
                // Show search stats
                const searchTime = Date.now() - searchStartTime;
                $('#resultsCount').text(response.count);
                $('#searchTime').text(`(${searchTime}ms)`);
                $('#searchStats').show();
                
                // Show export buttons if there are results
                if (response.count > 0) {
                    $('#exportButtons').show();
                    // Show JEF section if available and there are results
                    if (jefAvailable) {
                        $('#jefSection').show();
                    }
                }
            } else {
                $('#noResults').show();
                console.error('Search error:', response.error);
            }
        },
        error: function(xhr, status, error) {
            $('#loadingIndicator').hide();
            $('#noResults').show();
            console.error('AJAX error:', error);
        }
    });
}

// Display search results
function displayResults(results) {
    const container = $('#searchResults');
    container.empty();
    
    // Only hide JEF scores if this is a new search (not a re-render from sorting/filtering)
    if (arguments[1] !== 'rerender') {
        hideAllJefScores();
    }
    
    if (results.length === 0) {
        $('#noResults').show();
        return;
    }
    
    results.forEach(function(result, index) {
        const resultHtml = `
            <div class="result-item" data-file-path="${escapeHtml(result.path)}" data-file-title="${escapeHtml(result.title)}" data-index="${index}">
                <div class="result-header" onclick="selectFileForJef('${result.path.replace(/'/g, "\\'")}', '${escapeHtml(result.title)}', ${index})">
                    <div class="result-title">${escapeHtml(result.title)}</div>
                    <div class="result-path">
                        <span class="path-text">${escapeHtml(result.path)}</span>
                        <button class="btn btn-sm btn-outline-primary ms-2 expand-btn" onclick="toggleResultContent(event, ${index})" title="Expand/Collapse content">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="result-meta">
                        <span class="match-count">${result.matches} matches</span>
                        <span class="ms-3">Modified: ${result.modified_date}</span>
                        <span class="ms-3">Size: ${formatFileSize(result.file_size)}</span>
                        ${result.create_time ? `<span class="ms-3">Created: ${result.create_time}</span>` : ''}
                        <div class="jef-score-container" id="jef-score-${index}" style="display: none;">
                            <span class="jef-score-badge" onclick="toggleJefDetails(event, ${index})" title="Click to expand JEF analysis details">
                                <i class="fas fa-shield-alt"></i> JEF: <span class="jef-score-value">--</span>
                            </span>
                        </div>
                    </div>
                </div>
                <div class="jef-details" id="jef-details-${index}" style="display: none;">
                    <div class="jef-details-content">
                        <div class="jef-details-loading">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="ms-2">Loading JEF analysis...</span>
                        </div>
                    </div>
                </div>
                <div class="result-content" id="content-${index}" style="display: none;">
                    <div class="content-loading">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Loading content...</span>
                    </div>
                </div>
            </div>
        `;
        container.append(resultHtml);
    });
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Export results
function exportResults(format) {
    // Show path type selection for CSV exports
    let pathType = 'relative';
    if (format === 'csv' || format === 'csv-paths') {
        const userChoice = prompt('Choose path type:\n\n1 = Relative paths (e.g., 2024/11/file.md)\n2 = Full paths (e.g., C:\\full\\path\\to\\file.md)\n\nEnter 1 or 2:', '1');
        
        // Handle user cancellation or invalid input
        if (userChoice === null) {
            return; // User cancelled
        }
        
        pathType = (userChoice === '2') ? 'full' : 'relative';
    }
    
    const searchParams = new URLSearchParams({
        terms: $('#searchTerms').val().trim(),
        exclude: $('#excludeTerms').val().trim(),
        mode: $('input[name="searchMode"]:checked').val(),
        searchIn: $('#searchIn').val(),
        caseSensitive: $('#caseSensitive').is(':checked'),
        dateFrom: $('#dateFrom').val(),
        dateTo: $('#dateTo').val(),
        pathType: pathType
    });
    
    window.open(`/export/${format}?${searchParams.toString()}`, '_blank');
}

// File Tree Management
function loadFileTree() {
    $.ajax({
        url: '/api/file-tree',
        method: 'GET',
        success: function(data) {
            fileTree = data;
            renderFileTree();
        },
        error: function() {
            $('#fileTree').html('<div class="text-danger p-3">Error loading file tree</div>');
        }
    });
}

function renderFileTree() {
    const container = $('#fileTree');
    container.empty();
    
    function renderNode(node, path = '', level = 0) {
        const isFolder = node.type === 'folder';
        const isExpanded = expandedFolders.has(path);
        const isIncluded = includedFolders.has(path);
        const isExcluded = excludedFolders.has(path);
        const isIgnored = ignoredItems.has(path);
        
        if (isIgnored) return '';
        
        let classes = ['tree-item'];
        if (isFolder) classes.push('tree-folder');
        else classes.push('tree-file');
        if (isIncluded) classes.push('included');
        if (isExcluded) classes.push('excluded');
        
        const indent = 'tree-indent '.repeat(level);
        const toggle = isFolder ? 
            `<span class="tree-toggle" onclick="toggleFolder('${path}')">${isExpanded ? '▼' : '▶'}</span>` : 
            '<span class="tree-toggle"></span>';
        const icon = isFolder ? 
            '<i class="fas fa-folder tree-icon"></i>' : 
            '<i class="fas fa-file-alt tree-icon"></i>';
        
        let html = `
            <div class="${classes.join(' ')}" 
                 data-path="${path}" 
                 oncontextmenu="showContextMenu(event, '${path}', this); return false;"
                 onclick="selectItem('${path}', this)">
                <span class="${indent}"></span>
                ${toggle}
                ${icon}
                ${node.name}
            </div>
        `;
        
        if (isFolder && isExpanded && node.children) {
            for (const [childName, childNode] of Object.entries(node.children)) {
                const childPath = path ? `${path}/${childName}` : childName;
                html += renderNode(childNode, childPath, level + 1);
            }
        }
        
        return html;
    }
    
    for (const [rootName, rootNode] of Object.entries(fileTree)) {
        container.append(renderNode(rootNode, rootName, 0));
    }
    
    updateFilterStatus();
}

function toggleFolder(path) {
    if (expandedFolders.has(path)) {
        expandedFolders.delete(path);
    } else {
        expandedFolders.add(path);
    }
    renderFileTree();
}

function selectItem(path, element) {
    $('.tree-item').removeClass('selected');
    $(element).addClass('selected');
    
    // If it's a markdown file, open it in the viewer
    if ($(element).hasClass('tree-file') && path.endsWith('.md')) {
        openFileViewer(path);
    }
}

function showContextMenu(event, path, element) {
    event.preventDefault();
    currentContextPath = path;
    currentContextItem = element;
    
    const menu = $('#contextMenu');
    menu.css({
        left: event.pageX + 'px',
        top: event.pageY + 'px'
    }).show();
}

function contextAction(action) {
    $('#contextMenu').hide();
    
    if (!currentContextPath) return;
    
    switch (action) {
        case 'include':
            includedFolders.add(currentContextPath);
            excludedFolders.delete(currentContextPath);
            break;
            
        case 'exclude':
            excludedFolders.add(currentContextPath);
            includedFolders.delete(currentContextPath);
            break;
            
        case 'includeSubfolders':
            includeSubfolders(currentContextPath);
            break;
            
        case 'excludeSubfolders':
            excludeSubfolders(currentContextPath);
            break;
            
        case 'expandFrom':
            expandFromPath(currentContextPath);
            break;
            
        case 'collapseFrom':
            collapseFromPath(currentContextPath);
            break;
            
        case 'addToIgnore':
            ignoredItems.add(currentContextPath);
            break;
            
        case 'removeFromIgnore':
            ignoredItems.delete(currentContextPath);
            break;
            
        case 'showInResults':
            searchInPath(currentContextPath);
            break;
            
        case 'copyPath':
            copyToClipboard(currentContextPath);
            break;
    }
    
    renderFileTree();
    
    // Update search if there are current search terms
    if ($('#searchTerms').val().trim()) {
        performSearch();
    }
}

function includeSubfolders(path) {
    includedFolders.add(path);
    excludedFolders.delete(path);
    
    // Recursively include all subfolders
    function includeChildren(node, currentPath) {
        if (node.type === 'folder' && node.children) {
            for (const [childName, childNode] of Object.entries(node.children)) {
                const childPath = currentPath ? `${currentPath}/${childName}` : childName;
                if (childNode.type === 'folder') {
                    includedFolders.add(childPath);
                    excludedFolders.delete(childPath);
                    includeChildren(childNode, childPath);
                }
            }
        }
    }
    
    const node = getNodeByPath(path);
    if (node) {
        includeChildren(node, path);
    }
}

function excludeSubfolders(path) {
    excludedFolders.add(path);
    includedFolders.delete(path);
    
    // Recursively exclude all subfolders
    function excludeChildren(node, currentPath) {
        if (node.type === 'folder' && node.children) {
            for (const [childName, childNode] of Object.entries(node.children)) {
                const childPath = currentPath ? `${currentPath}/${childName}` : childName;
                if (childNode.type === 'folder') {
                    excludedFolders.add(childPath);
                    includedFolders.delete(childPath);
                    excludeChildren(childNode, childPath);
                }
            }
        }
    }
    
    const node = getNodeByPath(path);
    if (node) {
        excludeChildren(node, path);
    }
}

function expandFromPath(path) {
    expandedFolders.add(path);
    
    function expandChildren(node, currentPath) {
        if (node.type === 'folder' && node.children) {
            for (const [childName, childNode] of Object.entries(node.children)) {
                const childPath = currentPath ? `${currentPath}/${childName}` : childName;
                if (childNode.type === 'folder') {
                    expandedFolders.add(childPath);
                    expandChildren(childNode, childPath);
                }
            }
        }
    }
    
    const node = getNodeByPath(path);
    if (node) {
        expandChildren(node, path);
    }
}

function collapseFromPath(path) {
    function collapseChildren(node, currentPath) {
        if (node.type === 'folder' && node.children) {
            for (const [childName, childNode] of Object.entries(node.children)) {
                const childPath = currentPath ? `${currentPath}/${childName}` : childName;
                if (childNode.type === 'folder') {
                    expandedFolders.delete(childPath);
                    collapseChildren(childNode, childPath);
                }
            }
        }
    }
    
    const node = getNodeByPath(path);
    if (node) {
        collapseChildren(node, path);
    }
}

function getNodeByPath(path) {
    const parts = path.split('/');
    let current = fileTree;
    
    for (const part of parts) {
        if (current[part]) {
            current = current[part];
        } else {
            return null;
        }
        if (current.children) {
            current = current.children;
        }
    }
    
    return current;
}

function searchInPath(path) {
    // Set search to focus on this path
    $('#searchTerms').val(`path:"${path}"`);
    performSearch();
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show brief success message
        const toast = $('<div class="alert alert-success position-fixed" style="top: 20px; right: 20px; z-index: 9999;">Path copied to clipboard!</div>');
        $('body').append(toast);
        setTimeout(() => toast.remove(), 2000);
    });
}

function refreshFileTree() {
    loadFileTree();
}

function expandAll() {
    function addAllFolders(node, currentPath) {
        if (node.type === 'folder') {
            expandedFolders.add(currentPath);
            if (node.children) {
                for (const [childName, childNode] of Object.entries(node.children)) {
                    const childPath = currentPath ? `${currentPath}/${childName}` : childName;
                    addAllFolders(childNode, childPath);
                }
            }
        }
    }
    
    for (const [rootName, rootNode] of Object.entries(fileTree)) {
        addAllFolders(rootNode, rootName);
    }
    
    renderFileTree();
}

function collapseAll() {
    expandedFolders.clear();
    renderFileTree();
}

function clearFilters() {
    includedFolders.clear();
    excludedFolders.clear();
    ignoredItems.clear();
    renderFileTree();
    
    // Re-run search if there are search terms
    if ($('#searchTerms').val().trim()) {
        performSearch();
    }
}

function updateFilterStatus() {
    $('#includedCount').text(includedFolders.size);
    $('#excludedCount').text(excludedFolders.size);
}

// JEF Integration Functions
function checkJefStatus() {
    $.get('/api/jef-status')
        .done(function(response) {
            jefAvailable = response.available;
            if (jefAvailable) {
                $('#jefStatus').html('<span class="text-success"><i class="fas fa-check-circle"></i> JEF is available</span>');
                loadJefTests();
            } else {
                $('#jefStatus').html('<span class="text-danger"><i class="fas fa-times-circle"></i> JEF not available</span>');
            }
        })
        .fail(function() {
            $('#jefStatus').html('<span class="text-danger"><i class="fas fa-times-circle"></i> Error checking JEF status</span>');
        });
}

function loadJefTests() {
    $.get('/api/jef-tests')
        .done(function(response) {
            jefTests = response.tests;
            const select = $('#jefTestType');
            select.empty().append('<option value="">Select test type...</option>');
            
            jefTests.forEach(function(test) {
                select.append(`<option value="${test.id}" data-requires-reference="${test.requires_reference}">${test.name}</option>`);
            });
            
            $('#jefControls').show();
        })
        .fail(function() {
            $('#jefStatus').html('<span class="text-danger"><i class="fas fa-times-circle"></i> Error loading JEF tests</span>');
        });
}

function toggleReferenceText() {
    const selectedOption = $('#jefTestType option:selected');
    const requiresReference = selectedOption.data('requires-reference');
    
    if (requiresReference) {
        $('#jefReference').show();
    } else {
        $('#jefReference').hide();
    }
    
    updateJefButtons();
}

function selectFileForJef(filePath, fileTitle, index) {
    // Remove previous selection highlighting
    $('.result-item').removeClass('selected');
    
    // Add selection highlighting
    $(`.result-item[data-file-path="${filePath}"]`).addClass('selected');
    
    selectedFile = {
        path: filePath,
        title: fileTitle,
        index: index
    };
    
    $('#jefSelectedFile').text(fileTitle);
    updateJefButtons();
}

function updateJefButtons() {
    const testSelected = $('#jefTestType').val();
    const fileSelected = selectedFile !== null;
    const hasResults = currentResults.length > 0;
    
    $('#jefSingleBtn').prop('disabled', !testSelected || !fileSelected);
    $('#jefBatchBtn').prop('disabled', !testSelected || !hasResults);
}

function runJefAnalysis(mode) {
    const testType = $('#jefTestType').val();
    const referenceText = $('#jefReferenceText').val();
    
    if (!testType) {
        alert('Please select a test type');
        return;
    }
    
    const selectedTest = jefTests.find(t => t.id === testType);
    if (selectedTest.requires_reference && !referenceText.trim()) {
        alert('This test requires reference text');
        return;
    }
    
    // Store current test type for color coding
    currentJefTestType = testType;
    
    if (mode === 'single') {
        if (!selectedFile) {
            alert('Please select a file to analyze');
            return;
        }
        runSingleJefAnalysis(selectedFile.path, testType, referenceText);
    } else if (mode === 'batch') {
        runBatchJefAnalysis(testType, referenceText);
    }
}

function runSingleJefAnalysis(filePath, testType, referenceText) {
    const data = {
        file_path: filePath,
        test_type: testType,
        reference_text: referenceText
    };
    
    // Show analysis status in the JEF section
    $('#jefStatus').html('<span class="text-info"><i class="fas fa-spinner fa-spin"></i> Running JEF analysis...</span>');
    
    $.ajax({
        url: '/api/jef-analyze',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            // Update the search result container if this file is in current results
            const resultIndex = currentResults.findIndex(r => r.path === filePath);
            if (resultIndex !== -1) {
                updateJefScoreInResult(resultIndex, response, testType);
                $('#jefStatus').html('<span class="text-success"><i class="fas fa-check-circle"></i> Analysis complete - check search results</span>');
            } else {
                $('#jefStatus').html('<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Analysis complete but file not in current results</span>');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Analysis failed';
            $('#jefStatus').html(`<span class="text-danger"><i class="fas fa-times-circle"></i> Analysis failed: ${error}</span>`);
            
            // Update the search result container with error state
            const resultIndex = currentResults.findIndex(r => r.path === filePath);
            if (resultIndex !== -1) {
                updateJefScoreInResult(resultIndex, {success: false, error: error}, testType);
            }
        }
    });
}

function runBatchJefAnalysis(testType, referenceText) {
    const filePaths = currentResults.map(r => r.path);
    const data = {
        file_paths: filePaths,
        test_type: testType,
        reference_text: referenceText
    };
    
    // Show analysis status in the JEF section
    $('#jefStatus').html(`<span class="text-info"><i class="fas fa-spinner fa-spin"></i> Running JEF analysis on ${filePaths.length} files...</span>`);
    
    $.ajax({
        url: '/api/jef-batch-analyze',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            // Update search result containers with JEF scores
            let successCount = 0;
            if (response.results && Array.isArray(response.results)) {
                response.results.forEach(jefResult => {
                    const resultIndex = currentResults.findIndex(r => r.path === jefResult.file_path);
                    if (resultIndex !== -1) {
                        updateJefScoreInResult(resultIndex, jefResult, testType);
                        if (jefResult.success) successCount++;
                    }
                });
            }
            $('#jefStatus').html(`<span class="text-success"><i class="fas fa-check-circle"></i> Batch analysis complete - ${successCount}/${response.results.length} files analyzed successfully</span>`);
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Batch analysis failed';
            $('#jefStatus').html(`<span class="text-danger"><i class="fas fa-times-circle"></i> Batch analysis failed: ${error}</span>`);
            
            // Update all search result containers with error state
            currentResults.forEach((result, index) => {
                updateJefScoreInResult(index, {success: false, error: error}, testType);
            });
        }
    });
}

function getScoreColorClass(result, testType) {
    // Extract percentage for color coding
    let percentage = 0;
    if (result && typeof result === 'object' && result.percentage !== undefined) {
        percentage = result.percentage;
    } else if (typeof result === 'number') {
        percentage = result * 100; // Convert score to percentage if needed
    }
    
    // Perfect score gets golden color
    if (percentage >= 100) return 'jef-score-perfect';
    
    // For methamphetamine test, 70%+ is excellent (green)
    // For other tests, use general thresholds
    if (testType === 'meth') {
        if (percentage >= 70) return 'jef-score-excellent';
        if (percentage >= 50) return 'jef-score-good';
        if (percentage >= 30) return 'jef-score-moderate';
        return 'jef-score-poor';
    } else {
        // General thresholds for other tests
        if (percentage >= 70) return 'jef-score-excellent';
        if (percentage >= 50) return 'jef-score-good';
        if (percentage >= 30) return 'jef-score-moderate';
        return 'jef-score-poor';
    }
}

// Note: Old JEF results functions removed - results now display directly in search containers

// Toggle result content expansion
// Uses lazy loading - content is fetched via AJAX only when first expanded
function toggleResultContent(event, index) {
    event.stopPropagation(); // Prevent triggering JEF selection
    
    const contentDiv = $(`#content-${index}`);
    const expandBtn = $(event.target).closest('.expand-btn');
    const icon = expandBtn.find('i');
    
    if (contentDiv.is(':visible')) {
        // Collapse
        contentDiv.slideUp(300);
        icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        expandBtn.attr('title', 'Expand content');
    } else {
        // Expand
        contentDiv.slideDown(300);
        icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        expandBtn.attr('title', 'Collapse content');
        
        // Load content if not already loaded
        if (contentDiv.find('.content-loading').length > 0) {
            displayInlineContent(index);
        }
    }
}

// Lazy load content from API when needed
function displayInlineContent(index) {
    const contentDiv = $(`#content-${index}`);
    const result = currentResults[index];
    
    if (!result) {
        contentDiv.html(`
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle"></i> 
                Result not found.
            </div>
        `);
        return;
    }
    
    // Check if content is already cached
    const cachedData = contentDiv.data('fileData');
    if (cachedData && cachedData.html_content) {
        displayCachedContent(index, cachedData);
        return;
    }
    
    // Show loading state
    contentDiv.html(`
        <div class="result-content-inner">
            <div class="text-center p-4">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2">Loading content...</div>
            </div>
        </div>
    `);
    
    // Load content via AJAX
    $.ajax({
        url: `/api/file-content/${encodeURIComponent(result.path)}`,
        method: 'GET',
        success: function(data) {
            if (data.success) {
                const fileData = {
                    raw_content: data.raw_content,
                    html_content: data.html_content,
                    file_path: data.file_path,
                    title: data.title
                };
                
                // Cache the data
                contentDiv.data('fileData', fileData);
                
                // Display the content
                displayCachedContent(index, fileData);
            } else {
                contentDiv.html(`
                    <div class="alert alert-danger m-3">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Error loading content: ${escapeHtml(data.error || 'Unknown error')}
                    </div>
                `);
            }
        },
        error: function(xhr) {
            let errorMsg = 'Failed to load content';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            contentDiv.html(`
                <div class="alert alert-warning m-3">
                    <i class="fas fa-exclamation-triangle"></i> 
                    ${escapeHtml(errorMsg)}
                </div>
            `);
        }
    });
}

// Display cached content
function displayCachedContent(index, fileData) {
    const contentDiv = $(`#content-${index}`);
    
    const contentHtml = `
        <div class="result-content-inner">
            <div class="content-controls">
                <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleContentView(${index})" id="viewToggle-${index}">
                    <i class="fas fa-code"></i> Raw
                </button>
                <button class="btn btn-sm btn-outline-primary me-2" onclick="copyResultContent(${index})">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <div class="content-display">
                <div class="content-rendered" id="rendered-${index}">
                    ${fileData.html_content}
                </div>
                <div class="content-raw" id="raw-${index}" style="display: none;">
                    <pre><code>${escapeHtml(fileData.raw_content)}</code></pre>
                </div>
            </div>
        </div>
    `;
    contentDiv.html(contentHtml);
}

// Toggle between rendered and raw view for result content
function toggleContentView(index) {
    const renderedDiv = $(`#rendered-${index}`);
    const rawDiv = $(`#raw-${index}`);
    const toggleBtn = $(`#viewToggle-${index}`);
    
    if (renderedDiv.is(':visible')) {
        renderedDiv.hide();
        rawDiv.show();
        toggleBtn.html('<i class="fas fa-eye"></i> Rendered');
    } else {
        rawDiv.hide();
        renderedDiv.show();
        toggleBtn.html('<i class="fas fa-code"></i> Raw');
    }
}

// Copy result content to clipboard
function copyResultContent(index) {
    const contentDiv = $(`#content-${index}`);
    const fileData = contentDiv.data('fileData');
    
    if (fileData && fileData.raw_content) {
        navigator.clipboard.writeText(fileData.raw_content).then(function() {
            // Show success feedback
            const copyBtn = $(`#content-${index} .content-controls .btn:contains('Copy')`);
            const originalHtml = copyBtn.html();
            copyBtn.html('<i class="fas fa-check text-success"></i> Copied!');
            setTimeout(() => {
                copyBtn.html(originalHtml);
            }, 2000);
        }).catch(function() {
            alert('Failed to copy content to clipboard');
        });
    }
}

// JEF Score Integration Functions
function toggleJefDetails(event, index) {
    event.stopPropagation(); // Prevent triggering other click handlers
    
    const detailsDiv = $(`#jef-details-${index}`);
    const badge = $(event.target).closest('.jef-score-badge');
    
    if (detailsDiv.is(':visible')) {
        // Collapse
        detailsDiv.slideUp(300);
        badge.removeClass('expanded');
    } else {
        // Expand
        detailsDiv.slideDown(300);
        badge.addClass('expanded');
        
        // Load JEF details if not already loaded
        if (detailsDiv.find('.jef-details-loading').length > 0) {
            loadJefDetailsForResult(index);
        }
    }
}

function updateJefScoreInResult(index, jefResult, testType) {
    const scoreContainer = $(`#jef-score-${index}`);
    const scoreBadge = scoreContainer.find('.jef-score-badge');
    const scoreValue = scoreContainer.find('.jef-score-value');
    
    // Store JEF data for sorting/filtering
    const filePath = currentResults[index]?.path;
    if (filePath) {
        jefResultsData[filePath] = {
            result: jefResult,
            testType: testType,
            index: index
        };
    }
    
    if (jefResult && jefResult.success) {
        const result = jefResult.result;
        const colorClass = getScoreColorClass(result, testType);
        
        // Update score display
        let displayText = '';
        if (result.percentage !== undefined) {
            displayText = `${result.percentage.toFixed(1)}%`;
        } else if (result.score !== undefined) {
            displayText = `${(result.score * 100).toFixed(1)}%`;
        } else {
            displayText = 'N/A';
        }
        
        scoreValue.text(displayText);
        scoreBadge.removeClass('jef-score-perfect jef-score-excellent jef-score-good jef-score-moderate jef-score-poor');
        scoreBadge.addClass(colorClass);
        scoreContainer.show();
        
        // Store JEF data for details expansion
        scoreContainer.data('jefResult', jefResult);
        scoreContainer.data('testType', testType);
    } else {
        // Show error state
        scoreValue.text('Error');
        scoreBadge.removeClass('jef-score-perfect jef-score-excellent jef-score-good jef-score-moderate jef-score-poor');
        scoreBadge.addClass('jef-score-poor');
        scoreContainer.show();
        
        // Store error data
        scoreContainer.data('jefResult', jefResult);
        scoreContainer.data('testType', testType);
    }
    
    // Show sorting controls if we have JEF results
    if (Object.keys(jefResultsData).length > 0) {
        $('#jefSortingControls').show();
    }
}

function loadJefDetailsForResult(index) {
    const scoreContainer = $(`#jef-score-${index}`);
    const jefResult = scoreContainer.data('jefResult');
    const testType = scoreContainer.data('testType');
    const detailsContent = $(`#jef-details-${index} .jef-details-content`);
    
    if (!jefResult) {
        detailsContent.html('<div class="alert alert-warning">No JEF analysis data available</div>');
        return;
    }
    
    if (jefResult.success) {
        const result = jefResult.result;
        const testName = jefTests.find(t => t.id === testType)?.name || testType;
        
        let detailsHtml = `
            <div class="jef-analysis-result">
                <div class="jef-analysis-header">
                    <span class="jef-test-type">${escapeHtml(testName)}</span>
                    <span class="jef-score-display">${formatJefScoreForDetails(result)}</span>
                </div>
        `;
        
        // Add detailed information
        if (result.score !== undefined) {
            detailsHtml += `<div class="jef-analysis-details">
                <strong>Raw Score:</strong> ${typeof result.score === 'number' ? result.score.toFixed(4) : result.score}
            </div>`;
        }
        
        if (result.percentage !== undefined) {
            detailsHtml += `<div class="jef-analysis-details">
                <strong>Percentage:</strong> ${typeof result.percentage === 'number' ? result.percentage.toFixed(2) : result.percentage}%
            </div>`;
        }
        
        // Copyright-specific details
        if (result.ngram_scores !== undefined) {
            detailsHtml += `<div class="jef-analysis-details">
                <strong>N-gram Score:</strong> ${typeof result.ngram_scores === 'number' ? result.ngram_scores.toFixed(4) : result.ngram_scores}
            </div>`;
        }
        
        if (result.sentence_scores !== undefined) {
            detailsHtml += `<div class="jef-analysis-details">
                <strong>Sentence Score:</strong> ${typeof result.sentence_scores === 'number' ? result.sentence_scores.toFixed(4) : result.sentence_scores}
            </div>`;
        }
        
        // Show matches
        if (result.matches && Array.isArray(result.matches) && result.matches.length > 0) {
            detailsHtml += `<div class="jef-matches">
                <strong>Matches Found:</strong><br>
                ${result.matches.map(match => `<span class="jef-tag">${escapeHtml(match)}</span>`).join('')}
            </div>`;
        }
        
        // Show missing
        if (result.missing && Array.isArray(result.missing) && result.missing.length > 0) {
            detailsHtml += `<div class="jef-missing">
                <strong>Missing Elements:</strong><br>
                ${result.missing.map(missing => `<span class="jef-tag">${escapeHtml(missing)}</span>`).join('')}
            </div>`;
        }
        
        detailsHtml += '</div>';
        detailsContent.html(detailsHtml);
    } else {
        detailsContent.html(`
            <div class="alert alert-danger">
                <strong>Analysis Error:</strong> ${escapeHtml(jefResult.error || 'Unknown error occurred')}
            </div>
        `);
    }
}

function formatJefScoreForDetails(result) {
    if (result.percentage !== undefined) {
        return `${result.percentage.toFixed(2)}%`;
    } else if (result.score !== undefined) {
        return `${(result.score * 100).toFixed(2)}%`;
    } else {
        return 'N/A';
    }
}

function hideAllJefScores() {
    $('.jef-score-container').hide();
    $('.jef-details').hide();
    // Only hide sorting controls if we're clearing all JEF data (new search)
    if (arguments[0] === true) {
        $('#jefSortingControls').hide();
        jefResultsData = {};
    }
}

function showJefScoresForResults() {
    if (jefAvailable && currentResults.length > 0) {
        // Show JEF score containers for all results
        currentResults.forEach((result, index) => {
            $(`#jef-score-${index}`).show();
        });
    }
}

// JEF Results Sorting and Filtering for Search Results
function sortSearchResultsByJef() {
    // Store current filter values before any operations
    const currentMinScore = $('#jefFilterScore').val();
    const currentMinPercentage = $('#jefFilterPercentage').val();
    const sortBy = $('#jefSortBy').val();
    
    if (sortBy === 'original') {
        // Apply any active filters to the original order
        filterSearchResultsByJef();
        return;
    }
    
    const sortedResults = [...currentResults];
    
    sortedResults.sort((a, b) => {
        const aJef = jefResultsData[a.path];
        const bJef = jefResultsData[b.path];
        
        switch (sortBy) {
            case 'score-desc':
                const aScore = aJef?.result?.result?.score || 0;
                const bScore = bJef?.result?.result?.score || 0;
                return bScore - aScore;
            case 'score-asc':
                const aScoreAsc = aJef?.result?.result?.score || 0;
                const bScoreAsc = bJef?.result?.result?.score || 0;
                return aScoreAsc - bScoreAsc;
            case 'percentage-desc':
                const aPerc = aJef?.result?.result?.percentage || 0;
                const bPerc = bJef?.result?.result?.percentage || 0;
                return bPerc - aPerc;
            case 'percentage-asc':
                const aPercAsc = aJef?.result?.result?.percentage || 0;
                const bPercAsc = bJef?.result?.result?.percentage || 0;
                return aPercAsc - bPercAsc;
            case 'title':
                return a.title.localeCompare(b.title);
            case 'matches':
                return b.matches - a.matches;
            default:
                return 0;
        }
    });
    
    currentResults = sortedResults;
    displayResults(currentResults, 'rerender');
    restoreJefScores();
    
    // Restore filter values after re-rendering
    $('#jefFilterScore').val(currentMinScore);
    $('#jefFilterPercentage').val(currentMinPercentage);
    $('#jefSortBy').val(sortBy);
}

function filterSearchResultsByJef() {
    // Store current filter values before any operations
    const currentMinScore = $('#jefFilterScore').val();
    const currentMinPercentage = $('#jefFilterPercentage').val();
    const currentSortBy = $('#jefSortBy').val();
    
    const minScore = parseFloat(currentMinScore) || 0;
    const minPercentage = parseFloat(currentMinPercentage) || 0;
    
    let filteredResults = [...originalResultsOrder];
    
    if (minScore > 0 || minPercentage > 0) {
        filteredResults = filteredResults.filter(result => {
            const jefData = jefResultsData[result.path];
            if (!jefData || !jefData.result?.success) return false;
            
            const score = jefData.result.result?.score || 0;
            const percentage = jefData.result.result?.percentage || 0;
            
            return score >= minScore && percentage >= minPercentage;
        });
    }
    
    currentResults = filteredResults;
    displayResults(currentResults, 'rerender');
    restoreJefScores();
    
    // Restore filter values after re-rendering
    $('#jefFilterScore').val(currentMinScore);
    $('#jefFilterPercentage').val(currentMinPercentage);
    $('#jefSortBy').val(currentSortBy);
    
    // Apply current sorting after filtering
    if (currentSortBy !== 'original') {
        sortSearchResultsByJef();
    }
}

function clearJefFilters() {
    $('#jefFilterScore').val('');
    $('#jefFilterPercentage').val('');
    $('#jefSortBy').val('original');
    
    currentResults = [...originalResultsOrder];
    displayResults(currentResults, 'rerender');
    restoreJefScores();
}

function restoreJefScores() {
    // Restore JEF scores after re-rendering results
    currentResults.forEach((result, newIndex) => {
        const jefData = jefResultsData[result.path];
        if (jefData) {
            // Update the stored index
            jefData.index = newIndex;
            // Restore the score display without triggering the sorting controls show again
            const scoreContainer = $(`#jef-score-${newIndex}`);
            const scoreBadge = scoreContainer.find('.jef-score-badge');
            const scoreValue = scoreContainer.find('.jef-score-value');
            
            if (jefData.result && jefData.result.success) {
                const result = jefData.result.result;
                const colorClass = getScoreColorClass(result, jefData.testType);
                
                // Update score display
                let displayText = '';
                if (result.percentage !== undefined) {
                    displayText = `${result.percentage.toFixed(1)}%`;
                } else if (result.score !== undefined) {
                    displayText = `${(result.score * 100).toFixed(1)}%`;
                } else {
                    displayText = 'N/A';
                }
                
                scoreValue.text(displayText);
                scoreBadge.removeClass('jef-score-perfect jef-score-excellent jef-score-good jef-score-moderate jef-score-poor');
                scoreBadge.addClass(colorClass);
                scoreContainer.show();
                
                // Store JEF data for details expansion
                scoreContainer.data('jefResult', jefData.result);
                scoreContainer.data('testType', jefData.testType);
            } else {
                // Show error state
                scoreValue.text('Error');
                scoreBadge.removeClass('jef-score-perfect jef-score-excellent jef-score-good jef-score-moderate jef-score-poor');
                scoreBadge.addClass('jef-score-poor');
                scoreContainer.show();
                
                // Store error data
                scoreContainer.data('jefResult', jefData.result);
                scoreContainer.data('testType', jefData.testType);
            }
        }
    });
    
    // Ensure sorting controls remain visible if we have JEF data
    if (Object.keys(jefResultsData).length > 0) {
        $('#jefSortingControls').show();
    }
}

// Event listeners
$(document).ready(function() {
    // Search button click
    $('#searchButton').click(performSearch);
    
    // Enter key in search box
    $('#searchTerms').keypress(function(e) {
        if (e.which === 13) {
            performSearch();
        }
    });
    
    // Live search with debouncing
    $('#searchTerms').on('input', debounce(performSearch, 500));
    
    // Filter changes trigger search
    $('#excludeTerms, #searchIn, #dateFrom, #dateTo').on('change', function() {
        if ($('#searchTerms').val().trim()) {
            performSearch();
        }
    });
    
    $('input[name="searchMode"], #caseSensitive').on('change', function() {
        if ($('#searchTerms').val().trim()) {
            performSearch();
        }
    });
    
    // Focus on search box
    $('#searchTerms').focus();
    
    // Load file tree
    loadFileTree();
    
    // Check JEF status
    checkJefStatus();
    
    // Initialize file viewer
    initFileViewer();
    
    // Hide context menu on click outside
    $(document).click(function() {
        $('#contextMenu').hide();
    });
    
    // Prevent context menu from closing when clicking inside it
    $('#contextMenu').click(function(e) {
        e.stopPropagation();
    });
});

// File Viewer Functions
let currentFileData = null;
let isRawView = false;

function initFileViewer() {
    $('#toggleViewMode').click(function() {
        toggleViewMode();
    });
}

// TODO: Extract shared file loading logic to eliminate duplication with loadResultContent()
function openFileViewer(filePath) {
    // Show modal with loading state
    $('#fileViewerModal').modal('show');
    $('#fileViewerTitle').text('Loading...');
    $('#fileViewerContent').html(`
        <div class="text-center p-4">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div class="mt-2">Loading file content...</div>
        </div>
    `);
    $('#fileInfo').text('');
    
    // Load file content
    $.ajax({
        url: `/api/file-content/${encodeURIComponent(filePath)}`,
        method: 'GET',
        success: function(data) {
            if (data.success) {
                currentFileData = data;
                isRawView = false;
                displayFileContent();
                updateFileInfo();
            } else {
                showFileError(data.error || 'Failed to load file');
            }
        },
        error: function(xhr) {
            let errorMsg = 'Failed to load file';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            showFileError(errorMsg);
        }
    });
}

function displayFileContent() {
    if (!currentFileData) return;
    
    $('#fileViewerTitle').text(currentFileData.title);
    
    if (isRawView) {
        $('#fileViewerContent').html(`
            <textarea class="file-viewer-raw" readonly>${escapeHtml(currentFileData.raw_content)}</textarea>
        `);
        $('#toggleViewMode').html('<i class="fas fa-eye"></i> Rendered');
    } else {
        $('#fileViewerContent').html(`
            <div class="file-viewer-rendered">${currentFileData.html_content}</div>
        `);
        $('#toggleViewMode').html('<i class="fas fa-code"></i> Raw');
    }
}

function toggleViewMode() {
    if (!currentFileData) return;
    
    isRawView = !isRawView;
    displayFileContent();
}

function updateFileInfo() {
    if (!currentFileData) return;
    
    const fileSize = formatFileSize(currentFileData.file_size);
    const lastModified = new Date(currentFileData.last_modified * 1000).toLocaleString();
    
    $('#fileInfo').html(`
        <strong>Path:</strong> ${escapeHtml(currentFileData.file_path)} | 
        <strong>Size:</strong> ${fileSize} | 
        <strong>Modified:</strong> ${lastModified}
    `);
}

function copyFileContent() {
    if (!currentFileData) return;
    
    const content = isRawView ? currentFileData.raw_content : currentFileData.raw_content;
    
    navigator.clipboard.writeText(content).then(function() {
        // Show success feedback
        const originalText = $('#toggleViewMode').next().text();
        $('#toggleViewMode').next().html('<i class="fas fa-check text-success"></i> Copied!');
        setTimeout(() => {
            $('#toggleViewMode').next().html('<i class="fas fa-copy"></i> Copy');
        }, 2000);
    }).catch(function() {
        alert('Failed to copy content to clipboard');
    });
}

function showFileError(message) {
    $('#fileViewerTitle').text('Error');
    $('#fileViewerContent').html(`
        <div class="text-center p-4 text-danger">
            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
            <h5>Error Loading File</h5>
            <p>${escapeHtml(message)}</p>
        </div>
    `);
    $('#fileInfo').text('');
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

</script>
{% endblock %}